<html>

<head>
  <title></title>

  <style>
    input:invalid {
      background-color: lightpink;
    }
    
    #map {
      width: 800px;
      height: 500px;
      float: left;
    }
    
    #settings {
      float: left;
    }

    #dform input[type=text] {
      width: 250px;
    }
  </style>

  <!--<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.min.js"></script>-->
  <script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBSz0hJ73aWe62FiWuxfMxBBzOnJETyGv8&libraries=places&sensor=false"></script>
  <script type="text/javascript">
    //(function init_iife($) {
    window._maxDriveTime = 43200; // 12h in sec
    window._radiusEarth = 6371009; // in meters
    window._driveTimeMarkers = [];
    window._fuelMarkers = [];
    window._curRoute = null;
    window._mpg = 0;
    window._tanksize = 0;

    function calculate_drivetime_segments(route) {
      var drivetime = 0;
      // for each leg
      route.legs.forEach(function each_leg(leg) {
        drivetime += leg.duration.value;
        if(drivetime > _maxDriveTime) {
          drivetime -= leg.duration.value;
          leg.steps.forEach(function each_step(step) {
            drivetime += step.duration.value;
            if(drivetime > _maxDriveTime) {
              drivetime -= step.duration.value;
              // try to calculate where along the path
              // we reach or pass the limit
              var speed = step.distance.value / step.duration.value;
              // for each pair of points calculate the distance and the 
              // time to travel at speed.
              var p1 = step.path[0];
              for(var i = 1; i < step.path.length; i++) {
                var p2 = step.path[i];
                var greatArc = d3.geo.distance([p1.lng(),p1.lat()], [p2.lng(),p2.lat()]);
                var arcLen = greatArc * _radiusEarth;
                var time = arcLen / speed;
                drivetime += time;
                if(drivetime >= _maxDriveTime) {
                  console.log(p2);
                  _driveTimeMarkers.push(new google.maps.Marker({position: p2, map: gmap, title: "Drive time limit (" + (drivetime/3600) + "h)"}));
                  drivetime = 0;
                }
                p1 = p2;
              }
            }
          });
        }
      });
    }
    
    function clear_drivetime_pins() {
      _driveTimeMarkers.forEach(function(mkr) {
        mkr.setMap(null);
      });
      _driveTimeMarkers = [];
    }

    function calculate_fuel_stops(route, mpg, tanksize) {
      // mpg => meters/gal
      // tanksize => gal
      var maxDistance = mpg * tanksize;
      var distance = 0;
      route.legs.forEach(function each_leg(leg) {
        distance += leg.distance.value;
        if(distance > maxDistance) {
          distance -= leg.distance.value;
          leg.steps.forEach(function each_step(step) {
            distance += step.distance.value;
            if(distance > maxDistance) {
              distance -= step.distance.value;
              // for each pair of points calculate the distance
              var p1 = step.path[0];
              for(var i = 1; i < step.path.length; i++) {
                var p2 = step.path[i];
                var greatArc = d3.geo.distance([p1.lng(),p1.lat()], [p2.lng(),p2.lat()]);
                var arcLen = greatArc * _radiusEarth;
                distance += arcLen;
                if(distance >= maxDistance) {
                  console.log(p2);
                  _fuelMarkers.push(new google.maps.Marker({position: p2, map: gmap, title: "Fuel stop"}));
                  distance = 0;
                }
                p1 = p2;
              }
            }
          });
        }
      });
    }
    
    function clear_fuel_pins() {
      _fuelMarkers.forEach(function(mkr) {
        mkr.setMap(null);
      });
      _fuelMarkers = [];
    }
      
      /*$(*/
    document.addEventListener('DOMContentLoaded', function loaded() {
      var mapOptions = {
        "center": new google.maps.LatLng(39.828175, -98.5795),
        "zoom": 4
      };
      window.gmap = new google.maps.Map(document.getElementById('map'),mapOptions);
      var gds = new google.maps.DirectionsService();
      var gdr = new google.maps.DirectionsRenderer({map: gmap});
      var originAC = new google.maps.places.Autocomplete(document.getElementById("origin"), {types: ['geocode']});
      var destinationAC = new google.maps.places.Autocomplete(document.getElementById("destination"), {types: ['geocode']});
      d3.select('#search').on('click', function() { 
        var req = {
          "origin": document.getElementById("origin").value,
          "destination": document.getElementById('destination').value,
          "travelMode": google.maps.TravelMode.DRIVING
        };
        gds.route(req,
          function(res, stat) {
            if(stat !== google.maps.DirectionsStatus.OK) {
              // show some error?
              alert("Unable to calculate route.");
              return;
            }
            // render route
            gdr.setDirections(res);
            // begin drivetime segment calculation.
            window._curRoute = res.routes[0];
            calculate_drivetime_segments(res.routes[0])
          }
        );
      });
      d3.select('#maxdrivetime').on("change", function() {
        if(this.validity.valid) {
          _maxDriveTime = this.value * 3600;
          if(_curRoute) {
            clear_drivetime_pins();
            calculate_drivetime_segments(_curRoute);
          }
        }
      });
      d3.select('#mpg').on("change", function() {
        if(this.validity.valid) {
          // convert miles/gal to meters/gal because
          // google gives us distance in meters
          _mpg = this.value * 1609.34;
          if(_mpg && _tanksize && _curRoute) {
            // add fuel pins
            calculate_fuel_stops(_curRoute, _mpg, _tanksize);
          }
        }
      });
      d3.select('#tanksize').on("change", function() {
        if(this.validity.valid) {
          // convert miles/gal to meters/gal because
          // google gives us distance in meters
          _tanksize = this.value;
          if(_mpg && _tanksize && _curRoute) {
            // add fuel pins
            calculate_fuel_stops(_curRoute, _mpg, _tanksize);
          }
        }
      });
    });
    //})(jQuery);
  </script>
</head>

<body>
  <div>
    <form id="dform">
      <label for="origin">Start:</label>
      <input type="text" name="origin" id="origin">
      <label for="destination">End:</label>
      <input type="text" name="destination" id="destination">
      <br/>
      <input type="button" id="search" value="Route">
    </form>
  </div>
  <div>
    <div id="map"></div>
    <div id="settings">
      <label for="maxdrivetime">Max Driving Time (in hours):</label>
      <input type="text" name="maxdrivetime" id="maxdrivetime" value="12" pattern="\d*\.?\d+">
      <br>
      <label for="mpg">Vehicle MPG:</label>
      <input type="text" name="mpg" id="mpg" pattern="\d*\.?\d+">
      <br>
      <label for="tanksize">Vehicle Fuel Tank Size (gallons):</label>
      <input type="text" name="tanksize" id="tanksize" pattern="\d*\.?\d+">
    </div>
  </div>
</body>

</html>
